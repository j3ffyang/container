# Prometheus SNMP-Exporter for H3C on K8S

<!-- @import "[TOC]" {cmd="toc" depthFrom=2 depthTo=4 orderedList=false} -->
<!-- code_chunk_output -->

- [Objective](#objective)
- [Pre-requisite](#pre-requisite)
- [Add `helm` repo](#add-helm-repo)
- [Install `snmp-exporter`](#install-snmp-exporter)
- [Upgrade snmp_exporter docker image by editing `deployments`](#upgrade-snmp_exporter-docker-image-by-editing-deployments)
- [Edit SNMP-Exporter's `configMap` and insert `snmp.yml`](#edit-snmp-exporters-configmap-and-insert-snmpyml)
- [Update Prometheus by editing its `configMap`](#update-prometheus-by-editing-its-configmap)

<!-- /code_chunk_output -->


#### Objective

Showcase of how to configure SNMP-Exporter and Prometheus for H3C switch on K8S

#### Pre-requisite

- Kubernetes cluster
- Prometheus in a specific namespace, such as `monitoring`
- `nginx-ingress` is configured

#### Add `helm` repo

```sh
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
```

#### Install `snmp-exporter`

```sh
helm install snmp-exporter prometheus-community/prometheus-snmp-exporter \
  -n monitoring --set config=snmp.yml
```
#### Upgrade snmp_exporter docker image by editing `deployments`

```sh
k -n monitoring edit deployments.apps snmp-exporter-prometheus-snmp-exporter
```

To update image version to `v0.18.0` from `v0.14.0`, which fixes some issues at moment I configure this

```sh
    containers:
    - args:
      - --config.file=/config/snmp.yaml
      image: prom/snmp-exporter:v0.18.0
```

#### Edit SNMP-Exporter's `configMap` and insert `snmp.yml`

```sh
k -n monitoring edit cm snmp-exporter-prometheus-snmp-exporter
```

After insert `snmp.yml`, the `configMap` looks like

```sh
apiVersion: v1
data:
  snmp.yaml: |
    h3c_switch:
      walk:
      - 1.3.6.1.2.1.2.2.1.1
      - 1.3.6.1.2.1.2.2.1.13
...
      - 1.3.6.1.4.1.25506.2.6.1.1.1.1.6
      - 1.3.6.1.4.1.25506.2.6.1.1.1.1.8
      get:
      - 1.3.6.1.2.1.1.2.0
      - 1.3.6.1.2.1.1.3.0
      - 1.3.6.1.2.1.1.5.0
      - 1.3.6.1.2.1.2.1.0
      metrics:
      - name: sysObjectID
        oid: 1.3.6.1.2.1.1.2
        type: OctetString
        help: The vendor's authoritative identification of the network management subsystem
          contained in the entity - 1.3.6.1.2.1.1.2
...
    auth:
      community: {communityString}
kind: ConfigMap
metadata:
...
```

You may want to update `communityString` according to your settings

> Note: `snmp.yml` should be generated by `generator` automatically. Here's a reference https://programmer.group/prometheus-prometheus-monitoring-switch-snmp.html

#### Update Prometheus by editing its `configMap`

```sh
k -n monitoring edit cm prometheus-server
```

```sh

...
    scrape_configs:
    - job_name: 'snmp'
    static_configs:
      - targets:
        - 172.16.10.253
        - 172.18.10.251
    metrics_path: /snmp
    params:
      module: [h3c_switch]
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        # replacement: 10.244.2.10:9116
        replacement: 10.108.126.75:9116
...
```

Under `scrape_configs`, add switch IP(s) under `targets` and `replacement` value comes from

```sh
k -n monitoring get svc snmp-exporter-prometheus-snmp-exporter
```
