# Gitlab on Kubernetes w/ PV

## Objective

Build a Gitlab on Kubernetes cluster

#### Pre-requisite

- K8S of course
- `cert-manager` issuer
- A postgreSQL for persistent storage

> Reference >
> https://docs.gitlab.com/charts/quickstart/index.html
> https://docs.gitlab.com/charts/installation/deployment.html
> https://docs.gitlab.com/charts/advanced/external-db/index.html    # external database
> https://docs.gitlab.com/charts/advanced/persistent-volumes/index.html    # external storage
> https://docs.gitlab.com/charts/charts/gitlab/gitlab-runner/index.html    # runner's sub-chart
> https://docs.gitlab.com/charts/charts/minio/    # to disable `minio`

#### PostgreSQL

> Ref > https://github.com/helm/charts/tree/master/stable/postgresql

```sh
helm repo list

bitnami             	https://charts.bitnami.com/bitnami
```

```sh
k create ns gitlab

helm -n gitlab install postgresql stable/postgresql \
  --set global.postgresql.postgresqlPassword=secretPassword \
  --set persistence.enabled=true
```

```sh
kubectl port-forward --namespace gitlab svc/postgresql 5432:5432 &
PGPASSWORD="$POSTGRES_PASSWORD" psql --host 127.0.0.1 -U postgres -d postgres -p 5432
```

#### Gitlab


Since there are `nginx-ingress`, `cert-manager` and `prometheus` available in cluster, Gitlab doesn't need to reinstall the above. As there is no other application using `postgresql`, I decided to allow `gitlab` chart to manage `postgresql` installation.


```sh
helm install -n gitlab gitlab gitlab/gitlab  \
  --set global.hosts.domain=example.com  \
  --set certmanager-issuer.email=certmgr@example.com  \
  --set global.hosts.externalIP=172.16.50.201  \
  --set gitlab-runner.install=false  \
  --set nginx-ingress.enabled=false  \
  --set certmanager.install=false  \
  --set global.minio.enabled=false  \
  --set prometheus.install=false  \
  --set registry.enabled=false
```


By the way, we won't need `minio` either.

If you want to use an existing `postgresql`, here is the script. One **pre-requisite** is that a `gitlab` user must be created prior to installation

```sh
helm install -n gitlab gitlab gitlab/gitlab \
--set global.hosts.domain=example.com \
--set certmanager-issuer.email=certmgr@example.com \
--set postgresql.install=false \
--set global.psql.host=postgresql \
--set global.psql.password.secret=postgresql \
--set global.psql.password.key=postgresql-password  
```

#### Troubleshooting

###### DNS Resolving

- `k -n gitlab logs gitlab-gitlab-runner-7b7557c449-qk7qr`

```sh
...
WARNING: The user-mode requires you to manually start builds processing:
WARNING: $ gitlab-runner run                       
WARNING: Use sudo for system-mode:                 
WARNING: $ sudo gitlab-runner...                   

ERROR: Registering runner... failed                 runner=fqdJiLMC \
  status=couldn't execute POST against https://gitlab.example.com/api/v4/runners: \
  Post https://gitlab.example.com/api/v4/runners: dial tcp: lookup \
  gitlab.example.com on 10.96.0.10:53: no such host \  
PANIC: Failed to register this runner. Perhaps you are having network problems
...
```

- `k -n gitlab get svc | grep gitlab-webservice` find IP of `gitlab-webservice`

```sh
gitlab-webservice    ClusterIP    10.96.220.96    <none>    8080/TCP,8181/TCP    16h
```

- `k -n kube-system edit cm coredns` add an entry in `hosts`

```sh
apiVersion: v1
data:
  Corefile: |
    .:53 {
        errors
        health
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           upstream
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        hosts {
                10.96.220.96 gitlab.example.com
                fallthrough
        }
        prometheus :9153
        forward . /etc/resolv.conf
        cache 30
        loop
        reload
        loadbalance
    }
kind: ConfigMap
```

###### Find out the init passwd

```sh
kubectl get secret gitlab-gitlab-initial-root-password \
  -ojsonpath='{.data.password}' | base64 --decode ; echo
```

###### List all PV

```sh
kubectl --namespace gitlab get PersistentVolumeClaims \
  -l release=gitlab -ojsonpath='{range .items[*]}{.spec.volumeName}{"\t"}{.metadata.labels.app}{"\n"}{end}'
pvc-4790632e-374d-4919-801f-20a369a0ea17	minio
pvc-353cf91c-b3c7-4ee7-848b-8fc0fec1f5eb	prometheus
pvc-9f56dc78-971d-449b-a7f7-d42d7b633a52	redis
pvc-c2dc1a30-ff4e-421f-b02d-3dd45fe5b010	gitaly
```
